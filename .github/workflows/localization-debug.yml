name: Safe Debug Localization (Test Only)

on:
  workflow_dispatch: # Allows manual triggering only

env:
  UPSTREAM_REPO: Monolith-Station/Monolith
  UPSTREAM_BRANCH: master
  GAME_CONTENT_DIR: Resources/Prototypes
  TRANSLATED_CONTENT_DIR: Content
  LOCK_FILE: upstream-commit.lock
  EXTRACTED_FILE: en.json
  TRANSLATED_FILE: zh.json
  # PZ_PROJECT_ID: 16648 # Not needed for dry run, but good to keep structure

jobs:
  debug-test:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Monolith-CN Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          path: . 

      - name: 2. Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 3. Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 4. [Gatekeeper] Bypass - Force Run
        # We overwrite logic to ALWAYS run extraction for testing
        run: |
          echo "âš ï¸ DEBUG MODE: Bypassing update check. Forcing full run."
          echo "NEEDS_EXTRACTION=true" >> $GITHUB_ENV
          echo "NEW_UPSTREAM_SHA=debug_test_sha" >> $GITHUB_ENV

      - name: 5. Clone Upstream Repository
        if: env.NEEDS_EXTRACTION == 'true'
        run: |
          echo "Cloning upstream repository ${{ env.UPSTREAM_REPO }}..."
          git clone --depth 1 https://github.com/${{ env.UPSTREAM_REPO }}.git upstream_repo

      - name: 6. [Extract] Run Extraction Script
        if: env.NEEDS_EXTRACTION == 'true'
        run: |
          echo "Running extraction script..."
          # Note: We can test flags here like --by-folder if you want to test that feature later
          python ss14_tracker.py extract --source upstream_repo --target_folders ${{ env.GAME_CONTENT_DIR }} --output ${{ env.EXTRACTED_FILE }} --incremental

      - name: 7. [Mock Upload] Skip Paratranz Upload
        run: |
          echo "ðŸš« DRY RUN: Upload to Paratranz SKIPPED to protect data."
          echo "Generated file ${{ env.EXTRACTED_FILE }} is ready for inspection."

      - name: 8. [Mock Sync] Simulate Download
        run: |
          echo "ðŸš« DRY RUN: Download from Paratranz SKIPPED."
          echo "Logic: We will try to merge using an existing zh.json if present, or just fail safely."
          # For testing merge logic, we might need a dummy zh.json. 
          # Let's check if one exists in the repo, otherwise create a dummy one to test the merge script itself.
          if [ ! -f "${{ env.TRANSLATED_FILE }}" ]; then
            echo "Creating dummy translation file for merge testing..."
            echo '{"test_key": "è¿™æ˜¯æµ‹è¯•æ•°æ®"}' > ${{ env.TRANSLATED_FILE }}
          fi

      - name: 9. [Merge] Run Merge Script
        run: |
          echo "Running merge script..."
          if [ -f "${{ env.TRANSLATED_FILE }}" ]; then
            # We merge into the current directory structure
            python ss14_tracker.py merge --source . --input ${{ env.TRANSLATED_FILE }} --output . 
          else
            echo "Translated file not found, skipping merge."
          fi

      - name: 10. [Artifact] Upload Extraction Result
        uses: actions/upload-artifact@v4
        with:
          name: extracted-source-json
          path: ${{ env.EXTRACTED_FILE }}

      - name: 11. [Artifact] Upload Merged Resources
        uses: actions/upload-artifact@v4
        with:
          name: merged-resources-preview
          # We upload the specific folder where changes happen to verify them
          path: ${{ env.TRANSLATED_CONTENT_DIR }}
          # Or if changes are in Resources:
          # path: ${{ env.GAME_CONTENT_DIR }} 

      - name: 12. [Safety] No Commit
        run: |
          echo "ðŸš« DRY RUN: No changes will be committed to the repository."
